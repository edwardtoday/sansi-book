# 本周工作记录

20140614-20140621

本周在开发StarRiver通信程序的功能，并修复使用中发现的问题。

根据与曾磊的讨论，StarRiver 项目中我负责的部分还剩一个功能，相关文档和测试。功能预计在下周完成；测试计划在曾磊的两个程序都完成后，大约7月中下旬开始；最后编写测试文档以及说明书。

7月初开始可以继续显示屏校正项目的工作。

以下分类记录本周完成的主要任务。每日记录详见[日志](http://www.qingpei.me/sansi-book/worklog/201406.html)。

## 编码/测试

1. 数据库中添加 event 实现设备状态量的定时采样。
2. 同样通过 event 实现设备状态量采样按小时、按天汇总成均值、最大值、最小值。
3. 完成单灯固件升级功能（此前硬件只支持广播地址升级）。
4. 用 cron 自动备份数据库，并可配置保留最后N天的备份文件。
5. TCP 连接采取异步方式，避免一个离线的控制器影响其他控制器上任务的执行。至此，TCP 通信(连接、读、写)全部用异步操作。
6. 修改数据库设计，增加表和字段用于存储配置程序的用户数据。
7. 区分用户任务和自动后台任务，用户任务的优先级高于后台任务，插入队列时排在自动任务前。
8. 用 Rickshaw 尝试绘制历史状态图表。
    - 曾磊在做 C++ 实现，这样绘图相对工作量大，调整和扩展都需要很多时间。
    - 我能找到的易用的可视化程序库几乎都是 Javascript 的，包括 [D3.js](http://d3js.org/), [Rickshaw](http://code.shutterstock.com/rickshaw/), [Highcharts](http://www.highcharts.com/) 等。（刘工在项目管理的应用页面里就用了 Highcharts 绘图。）
    - 几个 JS 库绘制的都是矢量图，并且可以做到缩放、选择范围、显示光标所在位置数据点坐标、实时更新等用 C++ 从头开始写很费工夫的实用功能。
    - 如果用 JS 实现的历史查询效果好，可以作为备选方案，与控制程序分开提供。

## 文档

1. StarRiver测试计划。
2. 更新数据库设计文档以匹配最新的数据库设计。

## 备注

1. 有可能提升代码可读性、可维护性
  - 目前的通信程序中大量采用了 [Boost](http://www.boost.org/).Asio, Boost.Log 还有一些工具类。另外的一些函数，比如 CRC16, MD5 调用了我写的一个工具函数库。
  - 根据曾磊的反馈，以及网上对 Boost 的普遍看法，都认为这是个功能强大，但是代码难读的 C++ 库。
  - 所以我又找到了 [POCO C++ Library](http://pocoproject.org/)，其中包含的网络、编码、日志、散列、加密等许多模块都对应通信程序中的实际需求。
  - 在继续实现 StarRiver 功能之余，我考虑花少量时间了解一下 POCO 的使用，看是否可以让通信程序代码更容易看懂，更方便维护。
