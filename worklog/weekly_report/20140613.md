# 本周工作记录

20140607-20140613

本周全部时间用在 StarRiver 项目上。

6月25日有一个合同发货，现在一方面测试稳定性，一方面修正各自发现的bug。功能上在做设备历史状态查询，目前计划实现的查询范围包括电压、电流、功率、亮度。

以下分类记录本周完成的主要任务。每日记录详见[日志](http://www.qingpei.me/sansi-book/worklog/201406.html)。

## 编码/测试

1. 通信程序性能优化。
  - 根据唐德的提议，我写了软件模拟的控制器，用与压力测试。曾磊在数据库里插入了10个控制器，每个控制器下200个设备，共计2000个设备。
  - 20140606时的通信程序，一次性提交2000个单灯查询任务，处理能力约为20个任务每秒。
  - 经过7号到10号两天半的 `profile -> optimize` 迭代，处理能力提升到了近50个任务每秒。
  - 这个数字是在软件模拟器“执行”指令几乎不花时间的条件下达到的。
  - 近一半时间花费在SQL语句执行上，处理控制器响应内容的时间只占1/6左右。所以目前的瓶颈在于数据库性能。
  - 根据曾磊的意见，每秒50个灯的性能可以接受，暂不考虑花很多时间修改设计提升性能。
2. 增加任务优先级的概念，目前只有两类任务：用户提交的各种任务以及通信程序自动插入的查询任务。用户任务的优先级高于自动任务，会被通信程序放在任务队列头。
3. 从控制器查询到的状态量的值，统一单位，以 `double` 类型存入数据库。这里是为了方便各个协议的统一处理，以及方便画图。
4. 尝试实现数据库中设备状态的历史记录功能。
  - MySQL 可以通过 `trigger` 在状态更新时记录，也可以通过 `event` 定时采样。
  - 经过讨论和比较后，我决定采用定时方式记录状态量历史。优点是采样容量确定、每个允许查询的时间段内都保证能查询到记录、获取绘图需要的坐标简单直观。
  - 目前在测试数据库中实现了5分钟定时采样和每天将前一天的采样按小时汇总记录均值。
5. 提升通信程序对 Windows XP 的兼容性，避免使用 Windows XP 缺少的系统API。

## 文档

1. [StarRiver数据库安装、配置注意事项](http://www.qingpei.me/sansi-book/led_control/db_setup.html)

## 备注

无
